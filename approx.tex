%
\documentclass{article}
\usepackage{amsmath,amssymb,bbm,amsthm}
\usepackage{fullpage}
\usepackage{thm-restate,color,xcolor,xspace}
\usepackage{hyperref,cleveref}
\usepackage{algorithm,algorithmicx}
\usepackage[noend]{algpseudocode}

%%%%% BEGIN Jason's macros %%%%%
%\newcommand{\f}{\displaystyle\frac}
\newcommand{\f}{\frac}
\newcommand{\cd}{\cdot}
\newcommand{\bn}{\binom}
\newcommand{\sr}{\sqrt}
\newcommand{\cds}{\cdots}
\newcommand{\lds}{\ldots}
\newcommand{\vds}{\vdots}
\newcommand{\dds}{\ddots}
\newcommand{\pge}{\succeq}
\newcommand{\ple}{\preceq}
\newcommand{\sm}{\setminus}
\newcommand{\s}{\subseteq}
\newcommand{\su}{\supseteq}

\newcommand{\sumni}{\sum_{n=1}^\infty}
\newcommand{\sumin}{\sum_{i=1}^n}
\newcommand{\bigcupni}{\bigcup_{n=1}^\infty}
\newcommand{\bigcupin}{\bigcup_{i=1}^n}
\newcommand{\bigcapni}{\bigcap_{n=1}^\infty}
\newcommand{\bigcapin}{\bigcap_{i=1}^n}

\newcommand{\BE}{\begin{enumerate}}
\newcommand{\EE}{\end{enumerate}}
\newcommand{\im}{\item}
\newcommand{\BI}{\begin{itemize}}
\newcommand{\EI}{\end{itemize}}
\def\BAL#1\EAL{\begin{align*}#1\end{align*}}
\def\BALN#1\EALN{\begin{align}#1\end{align}}
\def\BG#1\EG{\begin{gather}#1\end{gather}}

\newcommand{\Sum}{\displaystyle\sum\limits}
\newcommand{\Prod}{\displaystyle\prod\limits}
\newcommand{\Int}{\displaystyle\int\limits}
\newcommand{\Lim}{\displaystyle\lim\limits}
\newcommand{\Max}{\displaystyle\max\limits}
\newcommand{\Min}{\displaystyle\min\limits}

\newcommand{\logn}{\log n}

\newcommand{\dx}{\frac d{dx}}
\newcommand{\dy}{\frac d{dy}}
\newcommand{\dz}{\frac d{dz}}
\newcommand{\dt}{\frac d{dt}}

\newcommand{\inv}{^{-1}}

\newcommand{\R}{\mathbb R}
\newcommand{\Z}{\mathbb Z}
\newcommand{\F}{\mathbb F}
\newcommand{\C}{\mathbb C}
\newcommand{\N}{\mathbb N}
\newcommand{\Q}{\mathbb Q}

\newcommand{\eps}{\epsilon}
\newcommand{\e}{\epsilon}
\newcommand{\de}{\delta}
\newcommand{\De}{\Delta}
\newcommand{\la}{\lambda}
\newcommand{\g}{\gamma}
\newcommand{\G}{\Gamma}
\newcommand{\pt}{\partial}
\newcommand{\al}{\alpha}
\newcommand{\be}{\beta}
\newcommand{\om}{\omega}
\newcommand{\Om}{\Omega}
\newcommand{\el}{\ell}
\renewcommand{\th}{\theta}
\newcommand{\Th}{\Theta}
\newcommand{\m}{\mathcal}
\newcommand{\ol}{\overline}

\newcommand{\Ra}{\Rightarrow}

\newcommand{\lf}{\lfloor}
\newcommand{\rf}{\rfloor}
\newcommand{\lc}{\lceil}
\newcommand{\rc}{\rceil}

\newcommand{\E}{\mathbb E}
\newcommand{\Var}{\textup{Var}}
\newcommand{\Cov}{\textup{Cov}}
\newcommand{\1}{\mathbbm 1}
\newcommand{\poly}{\textup{poly}}
\newcommand{\polylog}{\textup{polylog}}
\newcommand{\pl}{\textup{polylog}}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand{\vol}{\textbf{\textup{vol}}}

\newcommand{\rank}{\textup{rank}}
\newcommand{\spn}{\textup{span}}
\newcommand{\Tr}{\textup{Tr}}

\newcommand{\lp}{\left(}
\newcommand{\rp}{\right)}
\newcommand{\lb}{\left[}
\newcommand{\rb}{\right]}
\newcommand{\lmt}{\left[\begin{matrix}}
\newcommand{\rmt}{\end{matrix}\right]}


\newtheorem{theorem}{Theorem}

\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{observation}[theorem]{Observation}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{subclaim}[theorem]{Subclaim}
\newtheorem{fact}[theorem]{Fact}
\newtheorem{assumption}[theorem]{Assumption}

\newcommand{\BT}{\begin{theorem}}
\newcommand{\ET}{\end{theorem}}
\newcommand{\BL}{\begin{lemma}}
\newcommand{\EL}{\end{lemma}}
\newcommand{\BD}{\begin{definition}}
\newcommand{\ED}{\end{definition}}
\newcommand{\BC}{\begin{corollary}}
\newcommand{\EC}{\end{corollary}}
\newcommand{\BO}{\begin{observation}}
\newcommand{\EO}{\end{observation}}
\newcommand{\BCL}{\begin{claim}}
\newcommand{\ECL}{\end{claim}}
\newcommand{\BSCL}{\begin{subclaim}}
\newcommand{\ESCL}{\end{subclaim}}
\newcommand{\BF}{\begin{fact}}
\newcommand{\EF}{\end{fact}}
\newcommand{\BA}{\begin{assumption}}
\newcommand{\EA}{\end{assumption}}
\newcommand{\BP}{\begin{proof}}
\newcommand{\EP}{\end{proof}}
\newcommand{\BSP}{\begin{subproof}}
\newcommand{\ESP}{\end{subproof}}
\newcommand{\BPS}{\begin{proof}[Proof (Sketch)]}
\newcommand{\EPS}{\end{proof}}
\Crefname{observation}{Observation}{Observations}
\Crefname{claim}{Claim}{Claims}
\Crefname{subclaim}{Subclaim}{Subclaims}
\Crefname{fact}{Fact}{Facts}
\Crefname{assumption}{Assumption}{Assumptions}

\newenvironment{subproof}[1][\proofname]{%
  \renewcommand{\qedsymbol}{$\diamond$}%
  \begin{proof}[#1]%
}{%
  \end{proof}%
}

\newcommand{\alert}{\textcolor{red}}
\newcommand{\para}{\paragraph}
%\newcommand{\defn}{\textbf}

\newcommand{\tO}{\tilde{O}}

\newcommand{\thml}[1]{\label{thm:#1}}
\newcommand{\thm}[1]{\Cref{thm:#1}}
\newcommand{\leml}[1]{\label{lem:#1}}
\newcommand{\lem}[1]{\Cref{lem:#1}}
\newcommand{\defnl}[1]{\label{def:#1}}
\newcommand{\defn}[1]{\Cref{def:#1}}
\newcommand{\clml}[1]{\label{clm:#1}}
\newcommand{\clm}[1]{\Cref{clm:#1}}
\newcommand{\corl}[1]{\label{cor:#1}}
\newcommand{\cor}[1]{\Cref{cor:#1}}
\newcommand{\obsl}[1]{\label{obs:#1}}
\newcommand{\obs}[1]{\Cref{obs:#1}}
\newcommand{\eqnl}[1]{\label{eq:#1}}
\newcommand{\eqn}[1]{(\ref{eq:#1})}
\newcommand{\linel}[1]{\label{line:#1}}
\renewcommand{\line}[1]{line~\ref{line:#1}}
\newcommand{\secl}[1]{\label{sec:#1}}
\renewcommand{\sec}[1]{\Cref{sec:#1}}
%%%%% END Jason's macros %%%%%

\renewcommand{\emph}[1]{\textbf{\textup{#1}}}
\newcommand{\mincut}{\textsf{\textup{mincut}}}
\newcommand{\Rsmall}{R_\textup{small}}
\newcommand{\sma}{{\textup{small}}}
\newcommand{\lar}{{\textup{large}}}

\begin{document}

\title{Approximate Gomory-Hu Tree in Poly-logarithmic Max-flows}
\author{}
\date{\today}
\maketitle

\BD[Minimum isolating cuts]
Consider a weighted, undirected graph $G=(V,E)$ and a subset $R\s V$ ($|R|\ge2$). The \emph{minimum isolating cuts} for $R$ is a collection of sets $\{S_v:v\in R\}$ such that for each vertex $v\in R$, the set $S_v$ satisfies $S_v\cap R=\{v\}$ and has the minimum value of $w(\pt S'_v)$ over all sets $S'_v$ satisfying $S'_v\cap R=\{v\}$.
\ED

%\alert{DP: In the above definition, should we also mention that sets $S_v$ must be disjoint? At the moment, this is in the next lemma. Would putting it in the definition might make life a bit easier in terms of just having to refer to the definition when invoking this property?}

\BL
Fix a subset $R\s V$ ($|R|\ge2$). There is an algorithm that computes the minimum isolating cuts $\{S_v:v\in R\}$ for $R$ using $O(\log|R|)$ calls to $s$--$t$ max-flow on weighted graphs of $O(n)$ vertices and $O(m)$ edges, and takes $\tO(m)$ deterministic time outside of the max-flow calls. If the original graph $G$ is unweighted, then the inputs to the max-flow calls are also unweighted. Moreover, the sets $\{S_v:v\in R\}$ are disjoint.
\EL

%\alert{DP: In the above lemma, should we use $\lceil \lg |R|\rceil$ or $O(\log |R|)$? It depends on whether the constant is important to preserve.}

\BD[Single-source min-cut]
In the \emph{single-source min-cut} (SSMC) problem, the input is an undirected graph $G=(V,E)$ and a source vertex $s\in V$, and we need to output a $(s,v)$-mincut for each $v\in V\sm \{s\}$. In the \emph{$(1+\e)$-approximate SSMC} problem, the input is the same, and we need to output a $(1+\e)$-approximate $(s,v)$-mincut for each $v\in V\sm \{s\}$.
\ED


\BD[Gomory-Hu Steiner tree]
Given a graph $G=(V,E)$ and a set of terminals $U\s V$, the Gomory-Hu Steiner tree is a weighted tree $T$ on the vertices $U$, together with a function $f:V\to U$, such that
 \BI
 \im For all $s,t\in U$, consider the minimum-weight edge $(u,v)$ on the unique $s$--$t$ path in $T$. Let $U'$ be the vertices of the connected component of $T-(u,v)$ containing $s$.
Then, the set $f\inv(U')\s V$ is an $(s,t)$-mincut, and its value is $w_T(u,v)$.
 \EI
\ED

\BD[Approximate Gomory-Hu Steiner tree]
Given a graph $G=(V,E)$ and a set of terminals $U\s V$, the $(1+\e)$-approximate Gomory-Hu Steiner tree is a weighted tree $T$ on the vertices $U$, together with a function $f:V\to U$, such that
 \BI
 \im For all $s,t\in U$, consider the minimum-weight edge $(u,v)$ on the unique $s$--$t$ path in $T$. Let $U'$ be the vertices of the connected component of $T-(u,v)$ containing $s$.
Then, the set $f\inv(U')\s V$ is a $(1+\e)$-approximate $(s,t)$-mincut, and its value is $w_T(u,v)$.
 \EI
\ED

\BD[Rooted minimal Gomory-Hu Steiner tree]
Given a graph $G=(V,E)$ and a set of terminals $U\s V$, a rooted minimal Gomory-Hu Steiner tree is a Gomory-Hu Steiner tree on $U$, rooted at some vertex $r\in U$, with the following additional property:
 \BI
 \im[$(*)$] For all $s,t\in U$ where $s$ is a descendant of $t$ in the rooted tree $T$, consider the \emph{first} minimum-weight edge $(u,v)$ on the unique $s$--$t$ path in $T$. Let $U'$ be the vertices of the connected component of $T-(u,v)$ containing $s$.
Then, $\pt_Gf\inv(U')\s V$ is a \emph{minimal} $(s,t)$-mincut, and its value is $w_T(u,v)$.
 \EI
\ED

The following theorem, proved in APPENDIX, establishes the existence of a rooted minimal Gomory-Hu Steiner tree rooted at any given vertex.

\begin{restatable}{theorem}{Rooted}\thml{rooted}
For any graph $G=(V,E)$, terminals $U\s V$, and root $s\in U$, there exists a rooted minimal Gomory-Hu Steiner tree rooted at $s$.
\end{restatable}


\section{$(1+\e)$-approximate SSMC}


\begin{algorithm}
\caption{\textsc{CutThresholdStep}$(G=(V,E),s,U,W)$} 
\begin{algorithmic}[1]
\State Initialize $R^0\gets U$ and $D\gets\emptyset$
\For{$i$ from $0$ to $\lf\lg|U|\rf$}
 \State Compute minimum isolating cuts $\{S^i_v:v\in R^i\}$ on inputs $G$ and $R^i$ \linel{Sv}
 \State For each $v\in R^i\sm \{s\}$ where $w(\pt S^i_v)\le W$, add all vertices in $S^i_v\cap U$ to $D$
 \State $R^{i+1}\gets$ subsample of $R^i$ where each vertex in $R^i\sm \{s\}$ is sampled independently with probability $1/2$, and $s$ is sampled with probability $1$
\EndFor
\State\Return $D$
\end{algorithmic}
\end{algorithm}

Let $D$ be the output of the algorithm, and let $D^*$ be all vertices $v\in U\sm \{s\}$ for which the $(s,v)$-mincut has weight at most $W$. 

\BL\leml{step}
$D\s D^*$ and $\E[|D|] = \Om(|D^*|/\log|U|)$. 
\EL
\BP
We first prove that $D\s D^*$. Each vertex $u\in D$ belongs to some $S^i_v$ satisfying $w(\pt S^i_v)\le W$. %and $S^i_v\cap U=\{v\}$ for some $v\in U\sm s$. 
In particular, $\pt S^i_v$ is an $(s,u)$-cut with weight at most $ W$. It follows that the $(s,u)$-mincut also has weight at most $ W$, and therefore, $u\in D$.

It remains to prove that $\E[|D|]\ge\Om(|D^*|/\log|U|)$. Consider a rooted minimal Steiner Gomory-Hu tree $T$ of $G$ on terminals $U$ rooted at $s$, which exists by \thm{rooted}. By definition of the Steiner Gomory-Hu tree, a vertex $v\in U$ is in $D^*$ iff its path to the root $s$ in $T$ has at least one edge of weight at most $ W$. For each vertex $v\in U\sm \{s\}$, let $r(v)$ be defined as the child vertex of the lowest weight edge on the path from $v$ to $s$ in $T$. If there are multiple lowest weight edges, choose the one with the maximum depth. %\alert{The lowest weight edge is unique because there is only one $(v,s)$-mincut.}

%\alert{DP: 1. Need to define rooted minimal Steiner Gomory-Hu tree which is used in the para above. 3. Should we talk about breaking ties among multiple lowest weight edges or add a perturbation at the outset and claim that mincuts are unique? This last fact needs a proof since there could be exponential number of $s-t$ mincuts, so just adding an inverse polynomial perturabtion does not immediately imply uniqueness. But, perhaps use the (classic) isolation lemma?} \textcolor{blue}{I had assumed all $s-t$ mincuts unique in a previous write-up. I do think the new version is better since we also obtain better bounds for unweighted graphs which we can't use isolation lemma for. But maybe a note to the reader that assuming all min-cuts are unique could help with a first reading}

For each vertex $v\in D^*$, consider the subtree rooted at $v$, define $U_v$ to be the vertices in the subtree, and define $n_v$ as the number of vertices in the subtree. We say that a vertex $v\in D^*$ is \emph{active} if $v\in R^i$ for $i=\lf\lg n_{r(v)}\rf$. In addition, if $U_{r(v)}\cap R^i=\{v\}$, then we say that $v$ \emph{hits} all of the vertices in $U_{r(v)}$ (including itself). In particular, in order for $v$ to hit any other vertex, it must be active. For completeness, we say that any vertex in $U\sm D^*$ is not active and does not hit any vertex.

\alert{The above definitions are fine, but would be easier to read with (a) some intuition behind when you say that a vertex is active and process of hitting other vertices, and (b) a figure illustrating the notation.}

\textcolor{blue}{Jason: TODO add a figure here.}


To prove that $\E[|D|] \ge \Om(|D^*|/\log|U|)$, we will show that
 \BE
 \im[(a)] each vertex $u$ that is hit is in $D$, 
 \im[(b)] the total number of pairs $(u,v)$ for which $v\in D^*$ hits $u$ is at least $c |D^*|$ in expectation for some small enough constant $c>0$, and
 \im[(c)] with probability at least $1-\f c{2|U|^2}$ (for the constant $c>0$ in~(b)), each vertex $u$ is hit by at most $O(\log|U|)$ vertices $v\in D^*$. %\alert{DP: There's some play on constants here between the constant hidden in $O(.)$ and the constant in the denominator? Should we make this more explicit?}
 \EE

For (a), consider the path from $u$ to the root $s$ in $T$, and take any vertex $v\in D^*$ on the path that is active (possibly $u$ itself). Such a vertex must exist since $u$ is hit by some vertex. By definition, for $i=\lf\lg n_{r(v)}\rf$, we have $U_{r(v)}\cap R^i=\{v\}$, so $\pt U_{r(v)}$ is a $(v,R^i\sm \{v\})$-cut.  By the definition of $r(v)$, we have that $\pt U_{r(v)}$ is a $(v,s)$-mincut. On the other hand, we have that $\pt f\inv(S^i_v)$ is a $(v,R^i\sm v)$-mincut, so in particular, it is a $(v,s)$-cut. It follows that $\pt f\inv(U_{r(v)})$ and $\pt f\inv(S^i_v)$ are both $(v,s)$-mincuts and $(v,R^i\sm v)$-mincuts. Since $T$ is a minimal Gomory-Hu Steiner tree, we must have $f\inv(U_{r(v)}) \s S^i_v$. Since $u\in U_{r(v)}\s f\inv(U_{r(v)})\s S^i_v$, it is added to $D$ on \line{Sv}. 

For (b), for $i=\lf\lg n_{r(v)}\rf$, we have $v\in R^i$ with probability exactly $1/2^i = \Th(1/n_{r(v)})$, and with probability $\Om(1)$, no other vertex in $U_{r(v)}$ joins $R^i$. Therefore, $v$ is active with probability $\Om(1/n_{r(v)})$. Conditioned on $v$ being active, it hits exactly $n_{r(v)}$ many vertices. It follows that $v$ hits $\Om(1)$ vertices in expectation.

For (c), the number of vertices $v$ that hit vertex $u$ is at most the number of active vertices $v$ on the path from $u$ to $s$ in $T$. Label these vertices $u=v_1,v_2,\lds,v_\el=s$ in order. Each vertex $v_j\in D^*$ is active with probability $\Th(1/n_{r(v_j)})$, which is at most $\Th(1/j)$ since $v_1,\lds,v_j \in U_{r(v_j)}$. Each vertex $v_j\notin D^*$ is never active. Therefore, the expected number of active vertices on the path from $u$ to $s$ is at most $\sum_{j=1}^\el\Th(1/j)=\Th(\ln\el)\le \Th(\ln|U|)$. A standard Chernoff bound shows that with probability at least $1-\f c{2|U|^3}$ for any constant $c>0$, the number of active vertices on the path is indeed $O(\ln|U|)$, where the $O(\cd)$ hides the dependency on $c$. Taking a union bound over all $u\in U$, the probability that this is true for all vertices is at least $1-\f c{2|U|^2}$.

Finally, we show why properties (a) to (c) imply $\E[|D|] \ge \Om(|D^*|/\log|U|)$. In the event that property~(c) fails, the total number of pairs $(u,v)$ for which $v$ hits $u$ can be trivially upper bounded by $|U|^2$. Since this occurs with probability at most $\f c{2|U|^2}$, the total contribution to the expectation $c|D^*|$ in property~(b) is at most $c/2$. Therefore, the contribution to the expectation in the event that property~(c) succeeds is at least $c|D^*|-c/2\ge (c/2)|D^*|$. In this case, since each vertex is hit at most $O(\log|U|)$ times, there are at least $\Om(|D^*|/\log|U|)$ vertices hit in expectation.
\EP

%The following corollary will be useful in the next section:
%\BC\corl{Dmax}
%Let $D_{\max}$ be the largest set $\bigcup_{v\in R^i} (S^i_v\cap U)$ over all iterations $i$, and let $i_{\max}$ be the corresponding iteration. Then, $\E[|D_{\max}|] \ge \Om(|D^*|/\log^2|U|)$.
%\EC
%\BP
%There are $\lf\lg{U}\rf+1$ iterations in which we add to $D$, so $|D_{\max}|\ge |D|/(\lf\lg|U|\rf+1)$.
%Combining this with $\E[|D|]\ge\Om(|D^*|/\log|U|)$ from \lem{step} proves the claim. 
%\EP

\begin{algorithm}
\caption{\textsc{CutThreshold}$(G=(V,E),s, W)$}
\begin{algorithmic}[1]
\State Initialize $U\gets V$ and $D_{\textup{total}}\gets\emptyset$
\For{$O(\log^2n)$ iterations}
 \State $D\gets \textsc{CutThresholdStep}(G,s,U, W)$
 \State Update $D_{\textup{total}}\gets D_{\textup{total}}\cup D$ and $U\gets U\sm D$
\EndFor
\State\Return $D_{\textup{total}}$
\end{algorithmic}
\end{algorithm}


\BC\corl{threshold}
W.h.p., the output $D_{\textup{total}}$ of \textsc{CutThreshold} is exactly all vertices $v\in U\sm \{s\}$ for which the $(s,v)$-mincut has weight at most $ W$. 
\EC
\BP
%Let $D^*$ be the targeted output.
By \lem{step}, $|U\cap D^*|$ decreases by $\Om(|D^*|/\log n)$ in expectation. After $O(\log^2n)$ iterations, we have $\E[|U\cap D^*|] \le 1/\poly(n)$, so w.h.p., $U\cap D^*=\emptyset$. Each vertex in $D^*$ that is removed from $U$ is added to $D_{\textup{total}}$, and no vertices in $U\sm D^*$ are added to $D_{\textup{total}}$, so w.h.p., the algorithm returns the correct set $D^*$.
\EP


\begin{algorithm}
\caption{\textsc{ApproxSSMC}$(G=(V,E),s,\e)$}
\begin{algorithmic}[1]
 \State Initialize bounds: $ W_{\min} \gets$ minimum weight of an edge in $G$, and $ W_{\max}\gets$ maximum weight of an edge %\Comment{Every $(s,v)$-mincut has weight in $[ W_{\min}, W_{\max}]$}
 \For{all integers $i\ge0$ s.t.\ $(1+\e)^i W_{\min} \in [ W_{\min},(1+\e) n W_{\max}]$}
 \State $ W_i\gets (1+\e)^i W_{\min}$
 \State $D_i\gets \textsc{CutThreshold}(G,s, W)$
\EndFor
\State For each vertex $v\in V$, take the largest $D_i$ containing $v$, and set $\tilde\la(v)\gets  W_i$
\State\Return $\tilde\la:V\to \R$
\end{algorithmic}
\end{algorithm}

\BL
W.h.p., the output $\tilde\la$ of \textsc{ApproxSSMC} satisfies $\mincut(s,v) \le \tilde\la(v) \le (1+\e)\mincut(s,v)$.
\EL
\BP
Follows from \cor{threshold} and the fact that for all $v\in V$, there is an integer $i$ with $ W_i\in[\mincut(s,v),(1+\e)\mincut(s,v))$. 
\EP

\section{Approximate Gomory-Hu Steiner Tree}

\begin{algorithm}[H]
\caption{\textsc{ApproxSteinerGHTree}$(G=(V,E),U,\e)$} 
\begin{algorithmic}[1]
\State $\la_0\gets $ global Steiner mincut of $G$ with terminals $U$ \Comment{Sparsify if necessary}
\If{}
 \State $G'\gets\textsc{Sparsify}(G,)$
 \State\Return \textsc{ApproxSteinerGHTree}$(G=(V,E),U,\e)$
\EndIf

\State $s\gets$ uniformly random vertex in $U$
\State Call $\textsc{CutThresholdStep}(G,s,U,(1+\e)\la)$, and let $R^j$ and $S^j_v:v\in R^j$ ($0\le j\le\lg|U|$) be the intermediate variables in the algorithm\linel{thr}
\State For each $j\in\{0,1,\lds,\lf\lg|U|\rf\}$, let $R^j_\sma\gets \{ v\in R^j : |S^j_v\cap U|\le|U|/2 \}$  
\State Let $i\in\{0,1,\lds,\lf\lg|U|\rf\}$ be the iteration maximizing $\big|\bigcup_{v\in R^i_\sma} (S^i_v\cap U)\big|$ \linel{i}

\ \linel{max}
\For{each $v\in  R^i_\sma$} \Comment{Construct recursive graphs and apply recursion}
 \State Let $G_v$ be the graph $G$ with vertices $V\sm S^i_v$ contracted to a single vertex $x_v$ \Comment{$S^i_v$ are disjoint}
 \State Let $U_v\gets S^i_v\cap U$
 \State $(T_v,f_v)\gets \textsc{ApproxSteinerGHTree}(G_v,U_v,\e)$
\EndFor
\State Let $G_\lar$ be the graph $G$ with vertices $S^i_v$ contracted to a single vertex $y_v$ for all $v\in R^i_\sma$
\State Let $U_\lar\gets U\sm\bigcup_{v\in R^i_\sma}(S^i_v\cap U)$
\State $(T_\lar,f_\lar)\gets \textsc{ApproxSteinerGHTree}(G_\lar,U_\lar,\e)$

\
\State s \Comment{Combine Steiner Gomory-Hu trees together}
\State\Return blah

\end{algorithmic}
\end{algorithm}

\subsection{Approximation}

\BL\leml{large}
For any distinct vertices $p,q\in U_\lar$, $\mincut_{G_\lar}(p,q) = \mincut_G(p,q)$.
\EL
\BP
Since $G_\lar$ is a contraction of $G$, we have $\mincut_{G_\lar}(p,q) \ge \mincut_G(p,q)$. To show the reverse inequality, fix any $(p,q)$-mincut in $G$, and let $S$ be one side of the mincut. We show that for each $v\in  R^i_\sma$, either $S^i_v\s S$ or $S^i_v\s V\sm S$. Assuming this, the cut $\pt S$ stays intact when the sets $S^i_v$ are contracted to form $G_\lar$, so $\mincut_{G_\lar}(p,q) \le w(\pt S) = \mincut_G(p,q)$.

Consider any $v\in R^i_\sma$, and suppose first that $v\in S$. Then, $S^i_v\cap S$ is still a $(v,R^i\sm v)$-cut, and $S^i_v\cup S$ is still a $(p,q)$-cut. By the submodularity of cuts,
\[ w(\pt_GS^i_v) + w(\pt_GS) \ge w(\pt_G(S^i_v\cup S)) + w(\pt_G(S^i_v\cap S)). \]
In particular, $S^i_v\cap S$ must be a minimum $(v,R^i\sm v)$-cut. Since $S^i_v$ is the minimal $(v,R^i\sm v)$-mincut, it follows that $S^i_v\cap S = S^i_v$, or equivalently, $S^i_v\s S$.

Suppose now that $v\notin S$. In this case, we can swap $p$ and $q$, and swap $S$ and $V\sm S$, and repeat the above argument to get $S^i_v\s V\sm S$.
\EP

\BL\leml{small}
For any $v\in  R^i_\sma$ and any distinct vertices $p,q\in U_v$, $\mincut_{G_v}(p,q)\le(1+\e)\mincut_G(p,q)$.
\EL
\BP
Fix any $(p,q)$-mincut in $G$, and let $S$ be one side of the mincut. Since $S^i_v\cup S$ is a $(p,q)$-cut, it is in particular a Steiner cut for terminals $U$, so $w(S^i_v\cup S)\ge\la$. Also, $w(S^i_v)\le(1+\e)\la$ by the choice of the threshold $(1+\e)\la$ (\line{thr}). Together with the submodularity of cuts, we obtain
\[ (1+\e)\la+w(\pt_GS) \ge w(\pt_GS^i_v) + w(\pt_GS) \ge w(\pt_G(S^i_v\cup S)) + w(\pt_G(S^i_v\cap S)) \ge \la + w(\pt_G(S^i_v\cap S)) .\]
The set $S^i_v\cap S$ stays intact under the contraction from $G$ to $G_v$, so $w(\pt_{G_v}(S^i_v\cap S))=w(\pt_G(S^i_v\cap S))$. Therefore,
\[ \mincut_{G_v}(u,v)\le w(\pt_{G_v}(S^i_v\cap S))=w(\pt_G(S^i_v\cap S)) \le w(\pt_GS)+\e\la \le \mincut_G(u,v) + \e\,\mincut_G(u,v) ,\]
as promised.
\EP

\BL
\textsc{ApproxSteinerGHTree}$(G=(V,E),U,\e)$ outputs a $(1+\e)^{\lg|U|}$-approximate Gomory-Hu Steiner tree.
\EL
\BP
\alert{(sketch) Can only go to $G_v$ at most $\lg|U|$ times, picks up $(1+\e)$ factor each time}
\EP

\subsection{Running Time Bound}

In order for a recursive algorithm to be efficient, it must make substantial progress on each of its recursive calls. Here, there are two types: the recursive calls $(G_v,U_v,\e)$, and the single call $(G_\lar,U_\lar,\e)$. For each recursive call $(G_v,U_v,\e)$, we have $|U_v|\le|U|/2$ by construction, so we can set our measure of progress to be $|U|$, the number of terminals, which halves upon each recursive call.
However, progress on $(G_\lar,U_\lar,\e)$ is unclear; in particular, $|U_\lar|$ can be very close to $|U|$. For $G_\lar$, we define the following alternative measure of progress. Let $P(G,U,W)$ be the set of unordered pairs of distinct vertices whose mincut is at most $W$:
\[ P(G,U,W) = \bigg\{ \{u,v\}\in\bn U2:\mincut_G(u,v)\le W \bigg\} .\]
In particular, we will consider its size $|P(G,U,W)|$, and show the following expected reduction:

\BL\leml{P}
For any $W\le(1+\e)\la$, over the random selection of $s$ and the randomness in \textsc{CutThresholdStep}, we have
\[ \E[|P(G_\lar,U_\lar,W)|] \le \lp1-\Om\lp\f1{\log^2n}\rp\rp|P(G,U,W)| .\]
\EL

Before we prove \lem{P}, we show how it implies progress on the recursive call for $G_\lar$:
\BC\corl{mincut-increase}
Let $\la_0$ be the global Steiner mincut of $G$.
W.h.p., after $\Om(\log^3n)$ recursive calls along $G_\lar$ (replacing $G\gets G_\lar$ each time), the global Steiner mincut of $G$ is at least $(1+\e)\la_0$ (where $\la_0$ is still the global Steiner mincut of the initial graph).
\EC
\BP
Let $W=(1+\e)\la_0$.
Initially, we trivially have $|P(G,U,W)|\le\bn{|U|}2$. The global Steiner mincut can only increase in the recursive calls, since $G_\lar$ is always a contraction of $G$, so we always have $W\le(1+\e)\la$ for the current global Steiner mincut $\la$. By \lem{P}, the value $|P(G,U,W)|$ drops by factor $1-\Om(\f1{\log^2n})$ in expectation on each recursive call, so after $\Om(\log^3n)$ calls, we have
\[ \E[|P(G,U,W)|]\le\bn{|U|}2\cd\lp1-\Om\lp\f1{\log^2n}\rp\rp^{\Om(\log^3n)}\le\f1{\poly(n)} .\]
In other words, w.h.p., we have $|P(G,U,W)|=0$ at the end, or equivalently, the Steiner mincut of $G$ is at least $(1+\e)\la$.
\EP

Combining both recursive measures of progress together, we obtain the following bound on the recursion depth:
\BL
Let $W_{\min}=\min_{s,t\in U}\mincut(s,t)$ and $W_{\max}=\max_{s,t\in U}\mincut(s,t)$ be the minimum and maximum mincuts between two terminals. W.h.p., the depth of the recursion free of \textsc{ApproxSteinerGHTree} is $O(\e\inv\log^3n(\logn+\log(W_{\max}/W_{\min})))$.
\EL
\BP
For any $\Th(\log^3n)$ successive recursive calls down the recursion tree, either one call was on a graph $G_v$, or $\Th(\log^3n)$ of them were on the graph $G_\lar$. In the former case, $|U|$ drops by half, and in the latter case, by \cor{mincut-increase}, the global Steiner mincut increases by factor $(1+\e)$. The former can happen $O(\logn)$ times, and the latter $O(\e\inv\log(W_{\max}/W_{\min}))$ times, hence the bound.
\EP

\BC
For an unweighted graph $G=(V,E)$, and terminals $U\s V$, $\textsc{ApproxSteinerGHTree}(G,V,\e)$ takes time $\tO(m\e\inv)$ plus $\e\inv\pl(n)$ many calls to max-flow on $O(n)$-vertex, $O(m)$-edge graphs.
\EC
\BP
For a given recursion level, consider the instances $\{ (G_i,U_i,W_i)\}$ across that level. By construction, the terminals $U_i$ partition $U$. Moreover, the total number of vertices over all $G_i$ is at most $n+2(|U|-1)$ since each branch creates $2$ new vertices and there are at most $|U|-1$ branches. The total number of new edges created is at most the sum of weights of the edges in the final $(1+\e)$-approximate Gomory-Hu Steiner tree. For an unweighted graph, this is $O(m)$ by the following well-known argument. Root the Gomory-Hu Steiner tree $T$ at any vertex $r\in U$; for any $v\in U\sm r$ with parent $u$, the cut $\pt\{v\}$ in $G$ is a $(u,v)$-cut of value $\deg(v)$, so $w_T(u,v)\le\deg(v)$. Overall, the sum of the edge weights in $T$ is at most $\sum_{v\in U}\deg(v)\le2m$.
\EP

For weighted graphs, there is no nice bound on the number of new edges created throughout the algorithm. In the next section, we introduce a graph sparsification step to handle this issue.

Finally, we prove \lem{P} below.

\BP[Proof (\lem{P})]
Let $D^*$ be all vertices $v\in U\sm s$ for which the $(v,s)$-mincut has weight at most $ W$, and let $D^*_\sma\s D^*$ be all vertices $v\in U\sm s$ for which there exists an $(v,s)$-cut of weight at most $W$ whose side containing $v$ has at most $|U|/2$ vertices in $U$. Define $D_\sma = \bigcup_{j=0}^{\lf\lg|U|\rf}\bigcup_{v\in R^i_\sma} (S^i_v\cap U)$.
Let $P_{\text{ordered}}(G,U,W)$ be the set of ordered pairs $(u,v):u,v\in V$ for which there exists an $(u,v)$-mincut of weight at most $W$ with at most $|U|/2$ vertices in $U$ on the side $S(u,v)\s V$ containing $u$. %Observe that $|P_{\text{ordered}}(G,U,W)| \ge |P(G,U,W)|$, since for each pair $(u,v)$.
%For each ordered pair $(u,v)$ for which $\{u,v\}\in P(G,U,W)$, For each unordered pair $\{u,v\}\in P(G,U,W)$, consider the $(u,v)$-mincut of weight at most $W$. Let $S(\{u,v\})\s V$ be the side of the mincut with the smaller number of vertices in $U$, with a tie broken arbitrarily, and let $f(\{u,v\})\in\{u,v\}$ be whichever vertex ($u$ or $v$) is in $S(\{u,v\})$.
We now state and prove the following four properties:

\BE
\im[(a)] For all $u,v\in U$, $\{u,v\}\in P(G,U,W)$ if and only if either $(u,v)\in P_{\text{ordered}}(G,U,W)$ or $(v,u)\in P_{\text{ordered}}(G,U,W)$ (or both).
\im[(b)] For each pair $(u,v)\in P_{\text{ordered}}(G,U,W)$, we have $u\in D^*_\sma$ with probability at least $1/2$,
\im[(c)] For each $u\in D^*_\sma$, there are at least $|U|/2$ vertices $v\in U$ for which $(u,v)\in P_{\text{ordered}}(G,U,W)$.
\im[(d)] Over the randomness in \textsc{CutThresholdStep}$(G,U,(1+\e)\la)$, $\E[|D_\sma|]\ge\Om(|D^*_\sma|/\log|R|)$.
\EE

Property (a) follows by definition.
Property~(b) follows from the fact that $u\in D^*_\sma$ whenever $s\notin S(u,v)$, which happens with probability at least $1/2$. 
Property~(c) follows because any vertex $v\in U\sm S(u,v)$ satisfies $(u,v)\in P_{\text{ordered}}(G,U,W)$, of which there are at least $|U|/2$. Property~(d) can be proved for $\textsc{CutThresholdStep}(G,U,W)$ identically to the proof of \lem{step}, substituting $D^*$ for $D^*_\sma$. The only property we need is that $D^*_\sma$ is downward-closed, in the sense that for any vertex $v\in D^*_\sma$, all vertices in the subtree rooted at $v$ are also in $D^*_\sma$. Property~(d) actually concerns $\textsc{CutThresholdStep}(G,U,(1+\e)\la)$, but observe that the set $D_\sma$ can only increase if the weight parameter is increased from $W$ to $(1+\e)\la$.

With properties (a) to (d) in hand, we now finish the proof of \lem{P}. Consider the iteration $i$ maximizing the size of $D^i_\sma := \bigcup_{v\in R^i_\sma} (S^i_v\cap U)$ (\line{max}), so that $|D^i_\sma|\ge|D_\sma|/(\lf\lg|U|\rf+1)$. For any vertex $u\in D^i_\sma$, all pairs $(u,v)\in P_{\text{ordered}}(G,U,W)$ (over all $v\in U$) disappear from $P_{\text{ordered}}(G_\sma,U_\sma,W)$, which is at least $|U|/2$ many by (c). In other words, 
\[ |P_{\text{ordered}}(G,U,W)\sm P_{\text{ordered}}(G_\lar,U_\lar,W)| \ge \f{|U|}2|D^i_\sma| \ge\Om\lp\f{|D_\sma|}{\log|U|}\rp   .\]
Taking expectations and applying (d), 
\[ \E[|P_{\text{ordered}}(G,U,W)\sm P_{\text{ordered}}(G_\lar,U_\lar,W)|] \ge\Om\lp\f{\E[|D_\sma|]}{\log|U|}\rp    \ge \Om\lp\f{|U|\cd|D^*_\sma|}{\log^2|U|}\rp  .\]
Moreover,
\[ |U|\cd|D^*_\sma| \ge \E\big[\big| \{(u,v): u\in D^*_\sma\} \big|\big] \ge \f12|P_{\text{ordered}}(G,U,W)|,  \]
where the second inequality follows by (b). Putting everything together, we obtain
\[ \E[|P_{\text{ordered}}(G,U,W)\sm P_{\text{ordered}}(G_\lar,U_\lar,W)|] \ge \Om\lp\f{|P_{\text{ordered}}(G,U,W)|}{\log|R|}\rp   .\]
Finally, applying (a) gives
\BG \E[|P(G,U,W) \sm P(G_\lar,U_\lar,W)|] \ge \Om\lp\f{|P(G,U,W)|}{\log|R|}\rp .\nonumber%\eqnl{P}
\EG
Finally, we have $P(G_\lar,U_\lar,W) \s P(G,U,W)$ since the $(u,v)$-mincut for $u,v\in U_\lar$ can only increase in $G_\lar$ due to $G_\lar$ being a contraction of $G$ (in fact it says the same by \lem{large}). Therefore,
\[ |P(G,U,W)| - |P(G_\lar,U_\lar,W)| = |P(G,U,W) \sm P(G_\lar,U_\lar,W)| ,\]
and combining with the bound on $\E[|P(G,U,W) \sm P(G_\lar,U_\lar,W)|]$ concludes the proof.
\EP

\subsection{Weighted graphs}

Include a sparsification step to force linear number of edges on each recursive instance







\appendix

\section{Rooted minimal Gomory-Hu Steiner tree}

This section proves \thm{rooted}, restated below.
\Rooted*

Consider a Gomory-Hu Steiner tree $T$ on $U$ with the following special property. Root the tree $T$ at $s$. For each vertex $v\in U$, let $U_v\s U$ denote the vertices in the subtree rooted at $v$. Then, the multiset $M(T,f)=\{ |f\inv(U_v)| : v\in U\}$, once sorted from largest to smallest, is lexicographically minimal. Assuming this special condition, we claim that $T$ must be an $s$-minimal Gomory-Hu Steiner tree.

Suppose not, and let $s,t\in U$ be vertices violating $(*)$, chosen so that the depth of $t$ in the rooted tree $T$ is maximum possible. Consider the minimal $(s,t)$-mincut and let $S$ be the side containing $s$, so that $S\subsetneq f\inv(U_u)$.

\BCL\clml{Us}
For any $s'\in U_u\sm u$, we must have either $f\inv(U_{s'})\s S$ or $f\inv(U_{s'})\cap S=\emptyset$.
\ECL
\BP
Suppose the statement fails for some $s'\in U_u\sm u$. Let $t'\in U_u$ be the parent of $s'$.

Suppose first that $s'\in S$. Since $\pt(S\cup f\inv(U_{s'}))$ is an $(s,t)$-cut and $\pt(S\cap f\inv(U_{s'}))$ is an $(s',t')$-cut, by the submodularity of cuts,
\BAL
\mincut_G(s,t)+\mincut_G(s',t')&=w(\pt S)+w(\pt f\inv(U_{s'})) 
\\&\ge w(\pt(S\cup f\inv(U_{s'}))) + w(\pt(S\cap f\inv(U_{s'}))) 
\\&\ge \mincut_G(s,t) + \mincut_G(s',t'),
\EAL
so in particular, $\pt(S\cap f\inv(U_{s'})) \subsetneq f\inv(U_{s'})$ is an $(s',t')$-mincut, and the pair $(s',t')$ also violates $(*)$. Since $t'$ is a descendant of $t$, this contradicts our initial choice of $t$ whose depth is maximum possible.

Suppose next that $s'\notin S$. Since $\pt(S\sm f\inv(U_{s'}))$ is an $(s,t)$-cut and $\pt(f\inv(U_{s'})\sm S)$ is an $(s',t')$-cut, by the submodularity of cuts,
\BAL
\mincut_G(s,t)+\mincut_G(s',t')&=w(\pt S)+w(\pt f\inv(U_{s'})) 
\\&\ge w(\pt(S\sm f\inv(U_{s'}))) + w(\pt(f\inv(U_{s'})\sm S)) 
\\&\ge \mincut_G(s,t) + \mincut_G(s',t'),
\EAL
so in particular, $\pt(f\inv(U_{s'})\sm S)\subsetneq f\inv(U_{s'})$ is an $(s',t')$-mincut, and we obtain the same contradiction.
\EP

\BCL\clml{inS}
For any $s'\in U_u$, we must have $s'\in S$.
\ECL
\BP
By construction, every edge in $T$ on the path $P$ from $s$ to $u$ has weight greater than $\mincut_G(s,t)$. If $s'\notin S$ for some vertex $s'$ on the path $P$, then $S$ is a $(s,s')$-cut, so there must be an edge with weight at most $w(\pt S)=\mincut_G(s,t)$ on the path from $s$ to $s'$, a contradiction. Suppose now that some vertex $s'\in U_u$ not on the path $P$ satisfies $s'\notin S$. We can choose $s'$ whose depth in the rooted tree $T$ is minimum possible. Let $t'$ be the parent of $s'$, so that $t'\in S$. Since $S$ is an $(s',t')$-cut, we must have 
\[ w(\pt f\inv(U_{s'}))=\mincut(s',t')\le w(\pt S) = \mincut(s,t) ,\]
so $w_T(s',t')\le w_T(s,t)$. 
We modify the tree $T$ into $T'$ as follows. Remove the edge $(s',t')$, and add the edge $(s',t)$ of the same weight $w(\pt f\inv(U_{s'}))$. We claim that $(T',f)$ is still a Gomory-Hu Steiner tree, which can be checked on a case-by-base basis, most of which are trivial and therefore omitted. The only nontrivial case is when the minimum weight edge is $(u,t)$, because the only vertex whose subtree has a different set of vertices between $T$ and $T'$ is $u$, whose subtree in $T$ is $U_u\sm U_{s'}$. By \clm{Us}, $f\inv(U_{s'})\cap S=\emptyset$, and by the submodularity of cuts,
\BAL
\mincut_G(s,t)+\mincut_G(s',t')&=w(\pt f\inv(U_u))+w(\pt f\inv(U_{s'})) 
\\&\ge w(\pt(f\inv(U_u)\sm f\inv(U_{s'}))) + w(\pt(f\inv(U_{s'})\sm f\inv(U_u))) 
\\&\ge \mincut_G(s,t) + \mincut_G(s',t'),
\EAL
so $\pt (f\inv(U_u)\sm f\inv(U_s)) = \pt f\inv(U_u\sm U_s)$ is an $(s,t)$-mincut.

Therefore, $(T',f)$ is a Gomory-Hu Steiner tree.
Furthermore, the multiset $M(T',f)$, once sorted from largest to smallest, is lexicographically smaller. This contradicts the choice of $(T,f)$.
\EP

Combining \Cref{clm:Us,clm:inS}, we conclude that $u\in S$ and for all $s'\in U_u\sm u$, we must have $f\inv(U_{s'})\s S$. Since $S\subsetneq f\inv(U_u)$ by assumption, the only remaining possibility is $S\cap f\inv(u) \subsetneq f\inv(u)$. We modify $f$ into $f'$ as follows: we keep $f'(v)=f(v)$ for all $v\in V\sm(f\inv(u)\sm S)$, but we modify $f'(v)=t$ for all $v\in f\inv(u)\sm S$ (while $f(v)=u$). Then, $f\inv(U_u)=S$, and it is easy to verify that $(T,f')$ is a Gomory-Hu Steiner tree whose multiset $M(T,f')$, once sorted, is lexicographically smaller. This contradicts the choice of $(T,f)$.

Thus, the assumption $S\subsetneq f\inv(U_u)$ is false to begin with, concluding the proof of \thm{rooted}.





\end{document}
